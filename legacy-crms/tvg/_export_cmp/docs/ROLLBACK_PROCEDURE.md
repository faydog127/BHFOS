# Rollback Procedure

## 1. Overview
This document outlines the procedures for reverting changes at different levels of the application stack. This includes code rollbacks (Git), data rollbacks (Database), and application-level rollbacks (System Doctor).

## 2. Application-Level Rollback (System Doctor)
*For immediate reversal of admin actions or configuration changes.*

The application includes a built-in **Rollback Manager** for certain system actions.

1.  **Navigate**: Go to **Settings > Diagnostics > Audit Log**.
2.  **Identify**: Find the action you wish to reverse. Look for the "Rollback Available" indicator.
3.  **Analyze**: Click the action row. In the modal, select **"Preview Rollback"**.
    *   Review the `Inverse SQL` generated by the system.
    *   Check the "Risk Level" and "Affected Tables".
4.  **Execute**:
    *   Type "ROLLBACK" in the confirmation box.
    *   Click **Execute**.
5.  **Verify**: Check the specific module (e.g., if you rolled back a Pricing update, check the Pricebook) to ensure data is restored.

## 3. Git Code Rollback
*For reverting bad deployments.*

### Scenario A: Reverting a specific PR/Commit (Non-destructive)
1.  Identify the bad commit hash: `git log`
2.  Create a revert commit: `git revert <commit-hash>`
3.  Push the revert: `git push origin <branch-name>`
4.  This preserves history while undoing the changes.

### Scenario B: Emergency Reset to Previous Tag (Destructive to history on branch)
*Use with extreme caution. Coordinates with team required.*
1.  Checkout the last known good tag: `git checkout v2.4.9`
2.  Branch off for hotfix: `git checkout -b hotfix/rollback-v2.4.9`
3.  Force push (if necessary and approved) or standard push to deploy this branch as the new head.

## 4. Database Rollback (Supabase)
*For catastrophic data loss or corruption.*

### Option A: Point-in-Time Recovery (PITR)
*Requires Supabase Pro Plan*
1.  Log in to the Supabase Dashboard.
2.  Go to **Database > Backups**.
3.  Select **Point in Time Recovery**.
4.  Choose a timestamp *before* the corruption event.
5.  Initiate Restore. **Note:** This will overwrite the current database.

### Option B: Migration Rollback (Schema Only)
If a migration caused the issue:
1.  Identify the migration file (e.g., `20251216_new_table.sql`).
2.  Locate the corresponding "Down" migration or write inverse SQL (e.g., `DROP TABLE new_table`).
3.  Execute the Down SQL via the Supabase SQL Editor or CLI.

## 5. Communication Plan
In the event of a rollback:
1.  **Notify**: Post in the #dev-ops Slack channel immediately.
2.  **Status Page**: Update system status to "Maintenance" or "Degraded".
3.  **Post-Mortem**: Schedule a review meeting within 24 hours to analyze root cause.