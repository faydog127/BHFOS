# TVG OS Codebase Audit
**Generated:** 2025-11-25
**System:** TVG OS (The Vent Guys Operating System)

---

## 1. Route Configuration (`src/App.jsx`)

The application uses `react-router-dom` (v6) with a mix of public, protected CRM, and Admin Dashboard routes.

### Public Routes
| Path | Component | Description |
| :--- | :--- | :--- |
| `/` | `Home` | Main landing page |
| `/about` | `About` | Company info |
| `/services` | `Services` | Service listings |
| `/contact` | `Contact` | Contact form |
| `/blog` | `Blog` | Blog index |
| `/gallery` | `Gallery` | Project gallery |
| `/pricebook` | `Pricebook` | Pricing transparency |
| `/faq` | `FaqPage` | Frequently Asked Questions |
| `/booking` | `Booking` | Main booking flow |
| `/free-air-check` | `FreeAirCheck` | Landing page for "Free Air Check" offer |
| `/partners` | `PartnersLanding` | Main partner program hub |
| `/partners/*` | `RealtorPartner`, `PropertyManagerPartner`, etc. | Specific partner vertical LPs |
| `/partners/welcome` | `PartnerWelcome` | Post-registration success page |
| `/city-pages/*` | `Rockledge`, `Melbourne`, etc. | SEO landing pages for specific cities |

### CRM Routes (`/crm/*`)
Wrapped in `CrmLayout` for sidebar navigation.
| Path | Component | Status | Description |
| :--- | :--- | :--- | :--- |
| `/dashboard` | `CrmHome` | **Active** | Main overview dashboard |
| `/inbox` | `Inbox` | üöß *Pending* | Unified messaging inbox |
| `/schedule` | `Schedule` | üöß *Pending* | Calendar/Dispatch |
| `/customers` | `Customers` | üöß *Pending* | Customer directory |
| `/money` | `MyMoney` | üöß *Pending* | Financials/Invoicing |
| `/payroll` | `Payroll` | üöß *Pending* | Employee tracking |
| `/reporting` | `Reporting` | üöß *Pending* | Analytics reports |
| `/marketing` | `Marketing` | **Active** | Marketing Hub (Campaigns, Automations) |
| `/console` | `CallConsole` | **Active** | AI-assisted outbound dialing |
| `/pipeline` | `Pipeline` | **Active** | Lead management board |
| `/action-hub` | `ActionHub` | **Active** | Task management (Kanban/List) |
| `/leads-list` | `LeadsList` | **Active** | Detailed lead table |
| `/partner-submissions` | `PartnerSubmissions` | **Active** | Partner application management |
| `/settings` | `Settings` | **Active** | Global configs |
| `/admin` | `LegacyAdminPanel` | **Legacy** | User admin |
| `/metrics` | `Metrics` | **Active** | Template performance |

### Admin Dashboard Routes (`/admin/*`)
Separate layout for content management.
| Path | Component | Description |
| :--- | :--- | :--- |
| `/leads` | `AdminLeads` | Raw view of Klaire AI leads |
| `/partners` | `AdminPartners` | Raw view of partner table |
| `/image-asset-manager` | `ImageAssetManager` | Manage site images |
| `/image-diversity-tracker` | `DiversityTracker` | AI analysis of image diversity |
| `/upload-image` | `ImageUploadForm` | Upload tool |
| `/testimonials` | `TestimonialManager` | Manage reviews |

---

## 2. Component Inventory

### Core UI (`src/components/ui`)
*   Full suite of `shadcn/ui` components (Button, Card, Dialog, Input, Table, Tabs, Toast, etc.) implementing the design system.

### CRM: Marketing (`src/components/crm/marketing`)
*   `MarketingScoreboard.jsx`: Top-level KPIs (Leads, Channels, Partners).
*   `MarketingAnalytics.jsx`: Charts for lead sources and distribution.
*   `CampaignsManager.jsx`: CRUD for `marketing_campaigns` table.
*   `AutomationPlaybooks.jsx`: Visualizer for triggers/actions (`marketing_actions`).
*   `TemplateManager.jsx`: CRUD for email/SMS templates (`doc_templates`).

### CRM: Call Console (`src/components/crm/call-console`)
*   `CallConsole.jsx`: The main dialer interface with AI Copilot.
*   `LeadList.jsx`: Sidebar queue for leads.
*   `LeadCard.jsx`: Individual lead item with "Heat" score.
*   `PropertyInspectionPanel.jsx`: Interactive form for tech findings (AI Vision integration).
*   `CallLog.jsx`: History of interactions.

### CRM: Action Hub (`src/components/crm/action-hub`)
*   `ActionHubKanbanView.jsx`: Drag-and-drop task management.
*   `ActionHubListView.jsx`: Tabular task view.
*   `ActionHubCalendarView.jsx`: Calendar based task view.

### Forms
*   `LeadCaptureForm.jsx`: Multi-purpose public form (Contact/Free Air Check).
*   `PartnerRegistrationForm.jsx`: Application form for partners.
*   `FreeAirCheckModal.jsx`: Popup version of the intake form.
*   `ImageUploadForm.jsx`: Admin tool for assets.

---

## 3. Data Architecture (Supabase)

### Core Tables
1.  **`leads`**: The central record for all potential customers.
    *   *Used by:* `LeadCaptureForm`, `CallConsole`, `Pipeline`, `CrmHome`, `LeadsList`.
    *   *Key Columns:* `id`, `status`, `pqi` (Priority Quality Index), `persona`, `service`, `source_kind`.
2.  **`marketing_actions`**: Stores automated tasks generated by triggers.
    *   *Used by:* `AutomationPlaybooks`, `LeadsList`.
    *   *Key Columns:* `lead_id`, `playbook_key`, `status` (needs_approval, sent), `channel`.
3.  **`marketing_campaigns`**: Tracks inbound marketing efforts.
    *   *Used by:* `CampaignsManager`.
4.  **`partners`**: CRM profile for partners (Agents, PMs).
    *   *Used by:* `AdminPartners`.
    *   *Key Columns:* `tier`, `total_score`, `discount_code`.
5.  **`partner_registrations`**: Incoming applications from the landing page.
    *   *Used by:* `PartnerRegistrationForm`, `PartnerSubmissions`.
6.  **`doc_templates`**: Standardized responses for sales/marketing.
    *   *Used by:* `TemplateManager`.
7.  **`property_inspections`**: Technical data about a lead's home.
    *   *Used by:* `PropertyInspectionPanel`.
8.  **`global_config`**: Key/Value store for app settings (business hours, phone numbers).
    *   *Used by:* `Settings`.
9.  **`klaire_leads` / `klaire_contacts`**: Data from the AI Chatbot.
    *   *Used by:* `AdminLeads`, `KlaireChatWidget`.

### Database Triggers & Functions
*   `trigger_marketing_playbooks()`: Automatically inserts into `marketing_actions` when a new lead is created with specific services (e.g., "Free Air Check").
*   `handle_pqi_update()`: Recalculates lead score based on checklists/signals.

---

## 4. Status & Gaps

### ‚úÖ Completed / Functional
*   **Public Website:** Full marketing site with city pages and blog.
*   **Lead Intake:** robust forms with rate limiting and validation.
*   **Call Console:** Functional UI for calling, scripting, and logging.
*   **Marketing Hub:** Full suite for managing campaigns and viewing analytics.
*   **Action Hub:** Task management views (Kanban/List/Calendar).
*   **Partner Portal:** Landing pages and registration flow.

### üöß In Progress / Scaffolded / Placeholder
*   **`src/pages/crm/Inbox.jsx`**: Currently a placeholder. Needs integration with Email/SMS APIs (Twilio/SendGrid).
*   **`src/pages/crm/Schedule.jsx`**: Placeholder. Needs calendar implementation for job booking.
*   **`src/pages/crm/Customers.jsx`**: Placeholder. Needs distinct view from "Leads" for converted jobs.
*   **`src/pages/crm/Payroll.jsx`**: Placeholder.
*   **`src/pages/crm/MyMoney.jsx`**: Placeholder.
*   **`src/pages/crm/Reporting.jsx`**: Placeholder.

### ‚ö†Ô∏è Technical Debt / Notes
*   **Authentication:** `src/contexts/SupabaseAuthContext.jsx` is deprecated/blank. Auth seems to be handled via `src/lib/customSupabaseClient.js` or a newer context not fully visible in the provided file list, or running in a "Public Access Mode" for the CRM (indicated in `CrmLayout`).
*   **Image Caching:** `src/lib/homeImageCache.js` implements a caching strategy for Google Street View images to `leads` table.

---

## Marketing Factory ‚Äì Current State (2025-11-25)

### 1. ROUTES & PAGES (MARKETING FACTORY MAP)
| Route | Component | Role | Status |
| :--- | :--- | :--- | :--- |
| `/crm/marketing` | `Marketing.jsx` | **Central Hub** - Dashboard, Metrics, Nav | ‚úÖ Active |
| `/crm/marketing/console` | `MarketingConsole.jsx` | **Approval Layer** - Review AI content, Approve/Reject | ‚úÖ Active |
| `/crm/leads` | `Leads.jsx` | **Data Source** - Lead List & Pipeline Status | ‚úÖ Active |
| `/admin/leads` | `AdminLeads.jsx` | **Raw Data** - Admin view of raw tables | ‚úÖ Active |

### 2. SUPABASE INTEGRATION (TABLES & USAGE)
| Table | Purpose | Usage Status |
| :--- | :--- | :--- |
| `marketing_actions` | **The Queue**. Stores every triggered email/SMS. | ‚úÖ Heavy use. Central to the factory. |
| `marketing_campaigns` | **Configuration**. Stores source tracking (slugs, budgets). | ‚úÖ Used by CampaignManager. |
| `doc_templates` | **Content**. Stores email/SMS body templates. | ‚úÖ Used by TemplateManager. |
| `leads` | **The Trigger**. `marketing_channel`, `source`, `pipeline_stage`. | ‚úÖ Core data source. |
| `campaign_metrics` | **ROI Tracking**. Performance data. | ‚ùå **Scaffolded only**. Not connected to UI. |
| `marketing_content` | **AI Content**. Generated copy storage. | ‚ùå **Missing**. Does not exist in DB. |
| `brand_guidelines` | **AI Context**. Brand voice definitions. | ‚ùå **Missing**. Does not exist in DB. |

### 3. ORCHESTRATOR / AUTOMATION LAYER
*   **Mechanism:** Database Native (PL/pgSQL Trigger `trigger_marketing_playbooks`).
*   **Status:** ‚úÖ **Reactive Only**.
*   **Behavior:**
    *   Detects `INSERT` on `leads` (e.g. Free Air Check) -> Creates `marketing_actions` row (Day 0 & Day 3).
    *   Detects `UPDATE` on `leads` (Pipeline=Completed) -> Creates `marketing_actions` row (Review Request).
*   **Gap:** No "Proactive" layer. There is no Cron Job or Scheduled Edge Function to process deferred items (e.g. the "Day 3" follow-up created by the trigger sits in the queue forever unless manually processed).

### 4. APPROVAL LAYER (MARKETING CONSOLE)
*   **Component:** `MarketingConsole.jsx`.
*   **Status:** ‚úÖ **Fully Functional**.
*   **Features:**
    *   Lists all items with `status = 'needs_approval'`.
    *   Preview modal shows `content_preview` and `target_details`.
    *   Approve/Reject buttons update the database status.
    *   Reviewer Notes field allows coaching feedback.

### 5. SEND LAYER (EMAIL/SMS DISPATCH)
*   **Status:** ‚ùå **MISSING / MOCKED**.
*   **Current Behavior:**
    *   In `AutomationPlaybooks.jsx`: `handleApprove` uses `setTimeout` to simulate a network request, then updates DB status to 'sent'.
    *   In `MarketingConsole.jsx`: `updateStatus('approved')` updates DB status to 'approved'.
*   **The Gap:** There is **NO** backend service, Edge Function, or webhook listener that detects the 'approved' state and actually calls Twilio or SendGrid. The system is currently a "simulator".

### 6. ANALYTICS & FEEDBACK
*   **Visuals:** `MarketingAnalytics.jsx` provides excellent charts for Lead Source distribution and Share of Voice using the `leads` table.
*   **Metrics:** `campaign_metrics` table exists but is empty/unused. Real ROI (Cost per Lead, Conversion Rate) is not calculated.

### 7. GAPS VS TARGET ARCHITECTURE
| Feature | Target | Current Reality |
| :--- | :--- | :--- |
| **Triggering** | Real-time + Scheduled | Real-time (DB Trigger) ‚úÖ |
| **Content Gen** | AI-generated via Edge | Hardcoded in Trigger / Lib function exists but unwired ‚ö†Ô∏è |
| **Approval** | Human-in-the-loop UI | Fully implemented (`MarketingConsole`) ‚úÖ |
| **Dispatch** | Auto-send via API | **Non-existent** (Client-side simulation) ‚ùå |
| **Brand Voice** | Configurable Context | **Non-existent** ‚ùå |

### 8. BRUTALLY HONEST ASSESSMENT
The Marketing Factory is **60% complete**. The "Brain" (triggers) and the "Face" (Console) are built and working beautifully. You can capture a lead, have the DB automatically generate a plan (actions), and have a human review and approve that plan in a slick UI. However, the "Hands" are missing‚Äîapproving an action is purely administrative; no email or SMS actually leaves the system. It is currently a high-fidelity prototype of a marketing engine.

### 9. RECOMMENDED NEXT 3 STEPS
1.  **Implement the Dispatcher:** Create a Supabase Edge Function (`process-marketing-queue`) that runs every minute (via pg_cron or external cron), picks up `approved` actions, sends them via Twilio/SendGrid, and marks them `sent`.
2.  **Wire the AI Generator:** Connect the existing `generate-campaign-content` edge function to the `MarketingConsole` so users can regenerate copy if they don't like the default template.
3.  **Activate Campaign Metrics:** Update the `trigger_marketing_playbooks` to also increment counters in `campaign_metrics` so the Analytics tab shows real performance data beyond just lead counts.